package org.babyfish.jimmer.sql.filter;

import org.babyfish.jimmer.sql.JSqlClient;
import org.babyfish.jimmer.sql.common.AbstractQueryTest;
import org.babyfish.jimmer.sql.fetcher.RecursiveListFieldConfig;
import org.babyfish.jimmer.sql.filter.common.FileFilter;
import org.babyfish.jimmer.sql.model.filter.FileFetcher;
import org.babyfish.jimmer.sql.model.filter.FileTable;
import org.babyfish.jimmer.sql.runtime.ConnectionManager;
import org.junit.jupiter.api.Test;

import java.sql.Connection;
import java.util.function.Function;

public class QueryTest extends AbstractQueryTest {

    private JSqlClient sqlClient = getSqlClient(it -> {
        it.addFilters(new FileFilter());
        it.setConnectionManager(
                new ConnectionManager() {
                    @SuppressWarnings("unchecked")
                    @Override
                    public <R> R execute(Function<Connection, R> block) {
                        R[] resultBox = (R[])new Object[1];
                        jdbc(con -> {
                            resultBox[0] = block.apply(con);
                        });
                        return resultBox[0];
                    }
                }
        );
    });

    @Test
    public void testRecursive() {
        FileTable table = FileTable.$;
        FileFilter.withUser(2L, () -> {
            executeAndExpect(
                    sqlClient
                            .createQuery(table)
                            .where(table.parent().isNull())
                            .orderBy(table.id().asc())
                            .select(
                                    table.fetch(
                                            FileFetcher.$
                                                    .allScalarFields()
                                                    .childFiles(
                                                            FileFetcher.$.allScalarFields(),
                                                            RecursiveListFieldConfig::recursive
                                                    )
                                    )
                            ),
                    ctx -> {
                        ctx.sql(
                                "select tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID is null " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.statement(1).sql(
                                "select tb_1_.PARENT_ID, tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID in (?, ?) " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.statement(2).sql(
                                "select tb_1_.PARENT_ID, tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID in (?, ?, ?, ?, ?, ?, ?, ?) " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.statement(3).sql(
                                "select tb_1_.PARENT_ID, tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.statement(4).sql(
                                "select tb_1_.PARENT_ID, tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID in (?, ?) " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.statement(5).sql(
                                "select tb_1_.PARENT_ID, tb_1_.ID, tb_1_.NAME " +
                                        "from FILE tb_1_ " +
                                        "where " +
                                        "--->tb_1_.PARENT_ID in (?, ?, ?, ?, ?, ?, ?) " +
                                        "and " +
                                        "--->exists(" +
                                        "--->--->select 1 " +
                                        "--->--->from FILE_USER_MAPPING tb_3_ " +
                                        "--->--->where tb_3_.FILE_ID = tb_1_.ID and tb_3_.USER_ID = ?" +
                                        "--->) " +
                                        "order by tb_1_.ID asc"
                        );
                        ctx.rows(
                                "[" +
                                        "--->{" +
                                        "--->--->\"id\":1," +
                                        "--->--->\"name\":\"usr\"," +
                                        "--->--->\"childFiles\":[" +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":2," +
                                        "--->--->--->--->\"name\":\"bin\"," +
                                        "--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":3," +
                                        "--->--->--->--->--->--->\"name\":\"cd\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":4," +
                                        "--->--->--->--->--->--->\"name\":\"vim\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":6," +
                                        "--->--->--->--->--->--->\"name\":\"wait\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":7," +
                                        "--->--->--->--->--->--->\"name\":\"which\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}" +
                                        "--->--->--->--->]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":8," +
                                        "--->--->--->--->\"name\":\"sbin\"," +
                                        "--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":9," +
                                        "--->--->--->--->--->--->\"name\":\"ipconfig\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":11," +
                                        "--->--->--->--->--->--->\"name\":\"purge\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":12," +
                                        "--->--->--->--->--->--->\"name\":\"ssh\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}" +
                                        "--->--->--->--->]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":20," +
                                        "--->--->--->--->\"name\":\"share\"," +
                                        "--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":22," +
                                        "--->--->--->--->--->--->\"name\":\"dict\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":23," +
                                        "--->--->--->--->--->--->\"name\":\"sandbox\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":25," +
                                        "--->--->--->--->--->--->\"name\":\"locale\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->}" +
                                        "--->--->--->--->]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":26," +
                                        "--->--->--->--->\"name\":\"local\"," +
                                        "--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":27," +
                                        "--->--->--->--->--->--->\"name\":\"include\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->\"id\":28," +
                                        "--->--->--->--->--->--->--->--->\"name\":\"node\"," +
                                        "--->--->--->--->--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":29," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"v8-external.h\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}," +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":30," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"v8-internal.h\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}," +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":32," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"v8-object.h\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}," +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":33," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"v8-platform.h\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}" +
                                        "--->--->--->--->--->--->--->--->]" +
                                        "--->--->--->--->--->--->--->}" +
                                        "--->--->--->--->--->--->]" +
                                        "--->--->--->--->--->}," +
                                        "--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->\"id\":34," +
                                        "--->--->--->--->--->--->\"name\":\"lib\"," +
                                        "--->--->--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->\"id\":35," +
                                        "--->--->--->--->--->--->--->--->\"name\":\"node_modules\"," +
                                        "--->--->--->--->--->--->--->--->\"childFiles\":[" +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":36," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"npm\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}," +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":37," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"corepack\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}," +
                                        "--->--->--->--->--->--->--->--->--->{" +
                                        "--->--->--->--->--->--->--->--->--->--->\"id\":39," +
                                        "--->--->--->--->--->--->--->--->--->--->\"name\":\"docsify-cli\"," +
                                        "--->--->--->--->--->--->--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->--->--->--->--->--->--->}" +
                                        "--->--->--->--->--->--->--->--->]" +
                                        "--->--->--->--->--->--->--->}" +
                                        "--->--->--->--->--->--->]" +
                                        "--->--->--->--->--->}" +
                                        "--->--->--->--->]" +
                                        "--->--->--->}" +
                                        "--->--->]" +
                                        "--->}," +
                                        "--->{" +
                                        "--->--->\"id\":40," +
                                        "--->--->\"name\":\"etc\"," +
                                        "--->--->\"childFiles\":[" +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":41," +
                                        "--->--->--->--->\"name\":\"passwd\"," +
                                        "--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":43," +
                                        "--->--->--->--->\"name\":\"ssh\"," +
                                        "--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":44," +
                                        "--->--->--->--->\"name\":\"profile\"," +
                                        "--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->}," +
                                        "--->--->--->{" +
                                        "--->--->--->--->\"id\":45," +
                                        "--->--->--->--->\"name\":\"services\"," +
                                        "--->--->--->--->\"childFiles\":[]" +
                                        "--->--->--->}" +
                                        "--->--->]" +
                                        "--->}" +
                                        "]"
                        );
                    }
            );
        });
    }
}
