## 1. 大部分情况下不推荐flat

你应该尝试努力，尽可能减少对`flat`的使用，甚至让DTO语言仅用于生成输入类型，和查询相关的输出操作尽量用动态实体配合`@FetchBy`注解*（请参见[前后端免对接](../../spring/client)）*

本质原因：原生带有关联关系的数据结构是规范化数据，而经过`flat`处理后的的扁平对象是非关联数据。

然而，你很可能处在这样一种工作状态：和你对接的前端团队要求查询API一律返回扁平对象，要求除了集合属性意外的任何属性都必须经过`flat`处理，并且非常坚持。

现在解释为什么部分前端团队会有这种坚持。UI项目可以认为两种：

-   不需要状态管理的项目

    最大特色是界面上的功能区 *(排除顶栏和侧栏等非功能区)* 采用整体切换模式 *(以手机为代码的小屏幕设备更容易导致这种情况)*，因此，每个UI界面都是数据孤岛。

    此时，项目的主要复杂度在于UI绘制。前端开发人员无需关注数据模型，并期望所有API都返回平坦数据。

-   需要状态管理的项目

    最大特色是界面上的功能区是分散、并存和协同，因此，不同UI组件之间存在千丝万缕的联系。

    此时，项目的主要复杂度在于状态管理，前端开发人员必须高度关注数据模型的结构。

    前端状态管理，在从某种程度上讲，就是数据的规范化甚至关系化，大量的`flat`数据对这种项目具有破坏性。

如果前端团队从来没有经历过需要状态管理的UI项目，当然就无法意识到规范化数据的重要性。这时，就会形成对flat结构习惯性依赖，并拒绝接受看起来有违自己认知但其实没有什么成本的其他概念。

可以通过讨论来说服，表明规范化数据对状态管理的重要性，表明规范化数据对很多UI库而言不是问题，例如，[Antd中Table.Column](https://ant.design/components/table#column)的`dataIndex`属性的类型是`string | string[]`，其中，`string[]`就是对层次化数据的支持，不会导致开发遇到任何问题。

如果你所处角色对此没有话语权或无法说服对方，那么就可以使用`flat`函数来处理。

## 2. 特殊部分下可以考虑flat

有一种情况，适合采用`flat`，那就是字典。

字典是一个和枚举非常类似的概念。不同点在于

-   枚举是不可扩展的，所有取值在可能被固化在代码中。

    任何ORM *(包括Jimmer)* 都会对枚举直接支持

    -   如果认为系统的可观测性 *(新员工对系统的上手容易程度、出现问题后跨越部门协同的排查的容易程度)* 更重要，请将枚举映射为字符串。

    -   如果认为数据库对枚举的处理性能更重要，请将枚举映射为数字。

-   字段是可以在运行时扩展的，因此需要在数据库中单独建表，其他业务数据关联此表的记录即可。

    这种表非常简单，一般情况两三个字段即可

    -   `code`: 开发人员内部对字段名的约定，相当于代码编写中枚举常量的名称。

    -   `name`: 对用户展现的名称，开发人员不用。

    -   `descriptor`*(可选)*，一个更详细的描述，充当文档的作用，未必需要被查询出来并显示在界面上。

因为字典对象过于简单且高度稳定， `flat`风格是一种不错的选择。